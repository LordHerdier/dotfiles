# ~/.zsh_scriptlets
# Small scripts to make my life easier

function please() {
  # grab the previous command
  local last_cmd
  last_cmd=$(fc -ln -1)

  # let ‚Äôem know what‚Äôs up
  echo "üôè sudo $last_cmd"

  # actually run it
  eval "sudo $last_cmd"
}

theme() {
  if [[ -z "$1" ]]; then
    echo "Usage: omp-theme <theme>"
    return 1
  fi

  local newtheme="$1"
  local dir="$HOME/.oh-my-posh/themes"
  local json="$dir/${newtheme}.omp.json"
  local yaml="$dir/${newtheme}.omp.yaml"
  local config

  if [[ -f "$json" ]]; then
    config="$json"
  elif [[ -f "$yaml" ]]; then
    config="$yaml"
  else
    echo "No theme file found for '${newtheme}' (tried .json and .yaml)."
    return 1
  fi

  # persist theme to file
  echo "$newtheme" > ~/.omp_current
  # current session
  export OMPTHEME="${newtheme}"
  # re-init with whichever file we found
  eval "$(oh-my-posh init zsh --config "$config")"

  echo "OMP theme switched to ${newtheme} ($(basename "$config"))."
}

function mkcd() {
  mkdir -p -- "$1" && cd -P -- "$1"
}

themes() {
  local selection
  selection=$(/bin/ls ~/.oh-my-posh/themes/*.omp.{json,yaml} 2>/dev/null \
    | xargs -n1 basename \
    | sed -E 's/\.omp\.(json|yaml)$//' \
    | sort -u \
    | fzf --height=50% --reverse --prompt="Select theme ‚ñ∂ ")

  if [[ -n $selection ]]; then
    theme "$selection"
  else
    echo "No theme selected, nothing changed."
  fi
}

function omp-tinder() {
  # stash your current vibe
  local original
  original=$(<~/.omp_current 2>/dev/null)

  # grab all themes
  local themes=()
  local file t
  for file in "$HOME/.oh-my-posh/themes"/*.omp.json "$HOME/.oh-my-posh/themes"/*.omp.yaml; do
    [[ -f $file ]] || continue
    t=${file:t}             # basename
    t=${t%.omp.json}        
    t=${t%.omp.yaml}
    themes+=("$t")
  done

  [[ ${#themes[@]} -eq 0 ]] && {
    echo "üö® No OMP themes found in ~/.oh-my-posh/themes!"
    return 1
  }

  # where favorites live
  local fav_file=~/.omp_favorites
  touch "$fav_file"

  while true; do
    # pick one at (pseudo) random
    local idx=$(( RANDOM % ${#themes[@]} + 1 ))
    local theme_name=${themes[idx]}

    # show it off
    theme "$theme_name"

    # spin up a quick Zsh, re-init OMP with the same config, show the prompt, then bail
    local json="$HOME/.oh-my-posh/themes/${theme_name}.omp.json"
    local yaml="$HOME/.oh-my-posh/themes/${theme_name}.omp.yaml"
    local config
    if [[ -f $json ]]; then
      config=$json
    elif [[ -f $yaml ]]; then
      config=$yaml
    fi

   echo
   zsh -ic "eval \"\$(oh-my-posh init zsh --config '$config')\"; exit"
   echo

    echo
    # prompt for your next move
    local choice
    read -k1 "choice?[(n)ext/(f)avorite/(a)pply and quit/(q)uit] "
    echo

    case $choice in
      n)  # meh, next theme
          continue
          ;;
      f)  # keep it for later
          if ! grep -Fxq "$theme_name" "$fav_file"; then
            echo "$theme_name" >> "$fav_file"
            echo "‚òÖ Added '$theme_name' to $fav_file"
          else
            echo "‚òÖ '$theme_name' is already in $fav_file"
          fi
          continue
          ;;
      a)  # settle on this one
          echo "‚úÖ Applied and saved '$theme_name' as your new default."
          break
          ;;
      q)  # abort, go back to what you had
          if [[ -n $original ]]; then
            echo "‚Ü©Ô∏è  Reverting to '$original'."
            theme "$original"
          else
            echo "üîö Quitting without a previous theme to restore."
          fi
          break
          ;;
      *)  # unexpected
          echo "Use n, f, a, or q‚Äîyou know the drill."
          continue
          ;;
    esac
  done
}

