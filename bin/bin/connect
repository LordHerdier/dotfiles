#!/bin/bash
set -euo pipefail

# --- COLORS ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# 0. Safety Checks
for cmd in sshpass pass; do
    if ! command -v "$cmd" &> /dev/null; then
        echo -e "${RED}Error: '$cmd' is required but not installed.${NC}"
        exit 1
    fi
done

# Check if an IP/Hostname was provided
if [ -z "${1:-}" ]; then
    echo "Usage: $0 <hostname_or_ip>"
    exit 1
fi

INPUT=$1

# --- SMART TARGET LOGIC ---
DOMAIN_SUFFIX="${DEFAULT_DOMAIN:-.id.siue.edu}"

if [[ "$INPUT" != *.* ]]; then
    TARGET="${INPUT}${DOMAIN_SUFFIX}"
else
    TARGET="$INPUT"
fi

# --- CREDENTIALS FROM pass ---
ADMIN_USER="$(pass show crestron/creds/username | head -n1)"
ADMIN_PASS="$(pass show crestron/creds/password | head -n1)"

if [[ -z "$ADMIN_USER" || -z "$ADMIN_PASS" ]]; then
    echo -e "${RED}Error: Failed to retrieve admin credentials from pass.${NC}"
    exit 1
fi

# 1. SSH Options
SSH_OPTS="-o ConnectTimeout=4 \
-o StrictHostKeyChecking=no \
-o UserKnownHostsFile=/dev/null \
-o LogLevel=QUIET \
-o HostKeyAlgorithms=+ssh-rsa"

SUCCESS_THRESHOLD=5

echo -e "${CYAN}----------------------------------------${NC}"
echo -e "${CYAN}Targeting: ${TARGET}${NC}"
echo -e "${CYAN}----------------------------------------${NC}"

# --- PRIORITY 1: SSH as ADMIN ---
echo -e " ${YELLOW}[1/3] Attempting SSH as '${ADMIN_USER}' (via pass)...${NC}"

START_TIME=$SECONDS

# sshpass only reads SSHPASS at runtime, so keep it short-lived
SSHPASS="$ADMIN_PASS" \
sshpass -e ssh $SSH_OPTS "${ADMIN_USER}@${TARGET}"
EXIT_CODE=$?

DURATION=$(( SECONDS - START_TIME ))

# Immediately nuke secrets from memory
unset ADMIN_PASS SSHPASS

if [ $EXIT_CODE -eq 0 ] || [ $DURATION -gt $SUCCESS_THRESHOLD ]; then
    echo -e " ${GREEN}[Γ£ô] Session finished (admin).${NC}"
    exit 0
else
    echo -e " ${RED}[X] Auth failed or Connection Refused (Duration: ${DURATION}s)${NC}"
fi

echo ""

# --- PRIORITY 2: SSH as CRESTRON (Empty Password) ---
echo -e " ${YELLOW}[2/3] Attempting SSH as 'crestron' (No Password)...${NC}"

START_TIME=$SECONDS

sshpass -p "" ssh $SSH_OPTS crestron@"$TARGET"
EXIT_CODE=$?

DURATION=$(( SECONDS - START_TIME ))

if [ $EXIT_CODE -eq 0 ] || [ $DURATION -gt $SUCCESS_THRESHOLD ]; then
    echo -e " ${GREEN}[Γ£ô] Session finished (crestron).${NC}"
    exit 0
else
    echo -e " ${RED}[X] Connection failed.${NC}"
fi

echo ""

# --- PRIORITY 3: TELNET ---
echo -e " ${YELLOW}[3/3] Attempting Telnet on port 41795...${NC}"
echo -e "${CYAN}----------------------------------------${NC}"
telnet "$TARGET" 41795
